name: Autonomous TAYA Developer

on:
  # Esecuzione manuale
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no PR creation)'
        required: false
        default: 'false'
        type: boolean

  # Esecuzione schedulata: ogni lunedÃ¬ alle 9:00 UTC
  schedule:
    - cron: '0 9 * * 1'

permissions:
  contents: write
  pull-requests: write

jobs:
  taya-improve:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Git
        run: |
          git config --global user.name "TAYA Developer Bot"
          git config --global user.email "taya-bot@autonord.it"

      - name: Create improvement branch
        id: branch
        run: |
          BRANCH_NAME="taya-improvement-$(date +%s)"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Run TAYA Improver
        id: improve
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          npx tsx scripts/taya-improver.ts 2>&1 | tee taya-output.log
          
          # Check if there were any changes
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Build verification
        if: steps.improve.outputs.has_changes == 'true'
        run: pnpm run build

      - name: Commit changes
        if: steps.improve.outputs.has_changes == 'true'
        run: |
          git add -A
          git commit -m "refactor(taya): automated TAYA compliance improvement

          This commit was automatically generated by the TAYA Developer Bot.
          
          The bot scanned the codebase for violations of They Ask You Answer
          principles and made targeted improvements to enhance:
          - Price transparency
          - Honest product reviews
          - Educational content visibility
          - Clear call-to-actions
          
          See TAYA_RULES.md for the full list of principles."

      - name: Push branch
        if: steps.improve.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: git push origin ${{ steps.branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.improve.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ðŸŽ¯ TAYA Improvement: Automated Compliance Update" \
            --body "## Autonomous TAYA Developer
          
          Questo PR Ã¨ stato generato automaticamente dal **TAYA Developer Bot**.
          
          ### Cosa Ã¨ stato fatto
          
          Il bot ha scansionato il codice alla ricerca di violazioni dei principi 
          \"They Ask You Answer\" e ha apportato miglioramenti mirati.
          
          ### Regole TAYA applicate
          
          Consulta \`TAYA_RULES.md\` per la lista completa delle regole.
          
          ### Verifica
          
          - âœ… Build passato con successo
          - âœ… Nessun errore TypeScript
          
          ### Prossimi passi
          
          1. Rivedi le modifiche
          2. Testa localmente se necessario
          3. Approva e mergia
          
          ---
          *Generato automaticamente da GitHub Actions*" \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: taya-improver-logs
          path: taya-output.log
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## TAYA Improver Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.improve.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Changes were made and a PR was created" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No TAYA violations found or no changes needed" >> $GITHUB_STEP_SUMMARY
          fi
